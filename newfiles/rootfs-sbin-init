#!/bin/sh
# =============================================================
#  NextOS rootfs /sbin/init  — PID 1 after switch_root
#
#  This script is the first process in the real root filesystem.
#  It sets up the environment and hands off to the Python init
#  system at /system/init.py (or falls back to a shell).
# =============================================================

# ── Re-mount essential virtual filesystems ────────────────────
# They were moved over by initramfs/init, but re-mount defensively
mountpoint -q /proc || mount -t proc     proc     /proc
mountpoint -q /sys  || mount -t sysfs    sysfs    /sys
mountpoint -q /dev  || mount -t devtmpfs devtmpfs /dev 2>/dev/null || \
                       mount -t tmpfs    tmpfs     /dev

mkdir -p /dev/pts /dev/shm /run /tmp
mount -t devpts  devpts  /dev/pts 2>/dev/null
mount -t tmpfs   tmpfs   /run     2>/dev/null
mount -t tmpfs   tmpfs   /tmp     2>/dev/null

# ── Hostname ──────────────────────────────────────────────────
hostname nexos 2>/dev/null

# ── Console ───────────────────────────────────────────────────
# Redirect stdout/stderr to console so messages are visible
exec </dev/console >/dev/console 2>&1

# ── Environment ───────────────────────────────────────────────
export HOME=/root
export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/system
export TERM=linux

echo ""
echo "  NextOS root filesystem — init starting..."
echo ""

# ── Hand off to Python init system ────────────────────────────
if [ -x /usr/bin/python3 ] && [ -f /system/init.py ]; then
    echo "[init] Starting NextOS system manager (/system/init.py)"
    exec /usr/bin/python3 /system/init.py
fi

# Fallback: try python (python2 or symlinked)
if [ -x /usr/bin/python ] && [ -f /system/init.py ]; then
    echo "[init] Starting NextOS system manager (python)"
    exec /usr/bin/python /system/init.py
fi

# ── Final fallback: interactive shell ─────────────────────────
echo "[init] WARNING: /system/init.py not runnable — dropping to shell"
echo "[init] Install python3 into rootfs to enable the full init system."
echo ""

# Set a basic PS1 and go interactive
export PS1='\[\033[01;32m\]nexos\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '
exec /bin/bash --login 2>/dev/null || exec /bin/sh
